<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard Pesan â€” Modern</title>
  <style>
    :root{
      --bg: #f6f8fb;
      --card: #ffffff;
       --accent: #2563eb; /* calm deep blue */
       --muted: #6b7280; /* slightly warmer muted text */
       --success: #16a34a; /* pleasant green */
       --danger: #dc2626; /* keep as is */
      --radius: 10px;
      --glass: rgba(255,255,255,0.7);
    }
    *{box-sizing:border-box}
    body{font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); margin:0; padding:28px}
    .container{max-width:1100px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    header h1{font-size:20px;margin:0;color:#0f172a}
    header .meta{color:var(--muted);font-size:13px}

    .controls{display:flex;gap:10px;align-items:center;margin-bottom:16px}
    .controls .search{flex:1;display:flex;align-items:center;gap:8px}
    .controls input[type="search"]{flex:1;padding:10px 12px;border-radius:8px;border:1px solid #e6edf3;background:var(--card)}
    .controls select, .controls button{padding:10px 12px;border-radius:8px;border:1px solid #e6edf3;background:var(--card);cursor:pointer}
      .controls button.primary{background:var(--accent);color:white;border:none;box-shadow:0 4px 14px rgba(15,76,129,0.12)}

    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    .card{background:var(--card);border-radius:var(--radius);padding:12px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}

    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 10px;text-align:left;font-size:14px}
      thead th{background:var(--accent);color:white;position:sticky;top:0}
    tbody tr{border-bottom:1px solid #f1f5f9;transition:background .15s ease}
    tbody tr:hover{background:#f8fbff}

    .waid{font-weight:600;color:#0b1226}
    .snippet{color:var(--muted);font-size:13px;max-width:420px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .status{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px}
    .status.pending{background:#fff7ed;color:#92400e}
    .status.selesai{background:#ecfdf5;color:#065f46}

    .actions{display:flex;gap:8px}
    a.button{display:inline-block;padding:8px 10px;border-radius:8px;background:#eef2ff;color:#1e3a8a;text-decoration:none;font-weight:600}
    form.inline{display:inline}

    .small{font-size:12px;color:var(--muted)}

    /* responsive */
    @media (max-width:760px){
      .controls{flex-direction:column;align-items:stretch}
      th,td{padding:10px}
      .snippet{max-width:200px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1> Pesan Masuk</h1>
        <div class="meta">Dashboard <strong>Komplain</strong></div>
      </div>
      <div style="display:flex;gap:12px;align-items:center">
        <a href="/excluded" style="color:var(--accent);text-decoration:none;font-weight:600;font-size:13px"><strong>Kelola Pengecualian</strong></a>
        <div class="meta">Total: <strong><%= messages.length %></strong></div>
      </div>
    </header>

    <div class="controls">
      <div class="search">
        <input id="searchInput" type="search" placeholder="Cari WA ID, isi pesan...">
      </div>
      <select id="statusFilter">
        <option value="">Semua Status</option>
        <option value="pending">Pending</option>
        <option value="selesai">Selesai</option>
      </select>
      <select id="timeSort">
        <option value="newest">Terbaru</option>
        <option value="oldest">Terlama</option>
      </select>
      <button onclick="exportTableToExcel()" class="primary">Export CSV</button>
    </div>

    <div class="grid">
      <div class="card">
        <table id="messagesTable">
          <thead>
            <tr>
              <th style="width:22%">WA ID</th>
              <th style="width:48%">Isi</th>
              <th style="width:12%">Status</th>
              <th style="width:12%">Diterima</th>
              <th style="width:6%">Aksi</th>
            </tr>
          </thead>
          <tbody>
            <% for (const m of messages) { %>
              <tr data-id="<%= m.id %>">
                <td>
                  <div class="waid"><%= m.wa_id %></div>
                  <div class="small">ID: <%= m.id %></div>
                </td>
                <td>
                  <div class="snippet"><%= (m.text || '').replace(/</g, '&lt;').slice(0, 200) %></div>
                </td>
                <td>
                  <div class="status <%= m.status === 'pending' ? 'pending' : 'selesai' %>">
                    <%= m.status === 'pending' ? ' Pending' : ' Selesai' %>
                  </div>
                </td>
                <td class="small"><%= m.created_at %></td>
                <td>
                  <div class="actions">
                    <a class="button" href="/messages/<%= m.id %>">Detail</a>
                    <form class="inline" method="post" action="/messages/<%= m.id %>/delete" onsubmit="return confirm('Hapus pesan ini?')">
                      <button class="button" type="submit" style="background:#ffe9e9;border:none;color:#b91c1c">Hapus</button>
                    </form>
                  </div>
                </td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Simple interactive behaviour: search debounce, filter, sort
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const timeSort = document.getElementById('timeSort');

    let debounceTimer;
    searchInput.addEventListener('input', () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(applyFilters, 220); });
    statusFilter.addEventListener('change', applyFilters);
    timeSort.addEventListener('change', applyFilters);

    function applyFilters(){
      const q = (searchInput.value || '').toLowerCase().trim();
      const status = statusFilter.value;
      const sort = timeSort.value;
      const tbody = document.querySelector('#messagesTable tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));

      rows.forEach(r => {
        const text = (r.innerText || '').toLowerCase();
        const matchesQ = !q || text.includes(q);
        const st = r.querySelector('.status').innerText.toLowerCase();
        const matchesStatus = !status || st.includes(status);
        r.style.display = (matchesQ && matchesStatus) ? '' : 'none';
      });

      // Sort by date text (attempt parse)
      rows.sort((a,b)=>{
        const aText = a.querySelector('td:nth-child(4)').innerText;
        const bText = b.querySelector('td:nth-child(4)').innerText;
        const ta = Date.parse(aText) || 0;
        const tb = Date.parse(bText) || 0;
        return sort === 'oldest' ? ta - tb : tb - ta;
      });
      rows.forEach(r => tbody.appendChild(r));
    }

    function exportTableToExcel(){
      const rows = Array.from(document.querySelectorAll('#messagesTable tbody tr'));
      const csv = [['WA ID','ID','Isi','Status','Diterima']];
      rows.forEach(r => {
        const cells = r.querySelectorAll('td');
        if (r.style.display === 'none') return;
        const wa = cells[0].innerText.replace(/\n/g,' | ').replace(/,/g,'');
        const snippet = cells[1].innerText.replace(/,/g,'');
        const status = cells[2].innerText.replace(/,/g,'');
        const date = cells[3].innerText.replace(/,/g,'');
        const id = r.dataset.id || '';
        csv.push([wa,id,snippet,status,date]);
      });
      const csvString = csv.map(r=>r.join(',')).join('\n');
      const blob = new Blob([csvString], {type: 'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'messages.csv'; a.click(); URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>